* Command
** {./nix-copy.html}[nix-copy]
** Changelog
*** 2.19
    - (x) {https://nixos.org/manual/nix/stable/release-notes/rl-2.19}[notes].
    - `repl-flake` now a part of `flake`.
    - `flake#.attr` - preceding dot means not to look for attribute in default locations like `packages`.
    - `{./nix/builtins.html}[nix/builtins]
    - `fetch-tree` experimental feature in {./nix/builtins.html}[nix/builtins].
    - `nix flake update` supports `--update-input` but without flags, taking on the role of `nix flake lock`. Example: `nix flake update nixpkgs --flake /etc/flake`.
    -- `--update-input` consequently was removed.
    - `nix store add` - add file or dir to store and print its path.

* Functions
  - {./mkShell.html}[mkShell]
* Configuration
 See {./config.html}[config]
** Colors
   {./stylix.html}[stylix]
   {./nix-colors.html}[nix-colors]
** Services
   {https://search.nixos.org/options?channel=23.11&from=0&size=50&sort=relevance&type=packages&query=systemd.services.%3Cname%3E}[Options].
   Most important options:
   - `wants` vs `requires` - first create dependencies, but in the first case dependency is weak and referrer won't be affected by a referenced exiting.
   - `wantedBy` - makes service runnable.
   - `script` - what to do.
   - `environment` - drop your env here.
   - `serviceConfig`
   -- ( ) {https://www.freedesktop.org/software/systemd/man/latest/systemd.service.html}[Reference 1].
   -- ( ) {https://www.freedesktop.org/software/systemd/man/latest/systemd.exec.html}[Reference 2].
   -- `User` - who to run as.
   -- `Type` - type.
   --- ( ) {https://www.freedesktop.org/software/systemd/man/latest/systemd.service.html#Options}[Reference].
   --- `dbus` for dbus dependency, waits for unit to listen on a bus.
   --- `simple` - simplest, does least checks.
   --- `exec` - like simple, but makes little more checks. Preferrable for longer services without dbus or notify interface.
   --- `forking` - discouraged.
   --- `oneshot` - *default* waits for child to exit, i.e. the most demanding.
   --- etc.
   -- `RootDirectory` - dir to chroot into. e.g. `/run/myService`.
   -- `*Directory` - sets pwd, env, adds dependencies on mounts.
   --- `WorkingDirectory` - pwd, i.e. 'cd into'.
   ---  `Runtime`, `State`, `Cache`, `Logs`, `Configuration` - set corresponding env vars and create dirs under some special paths.
**** Tips
     - ( ) {https://nixos.wiki/wiki/Systemd_Hardening}[Source].
     - you can use `serviceConfig.DynamicUser = true` to not create a user system user, saving lines in `/etc/passwd`.
     - if networmk is needed with nm present, do 
       @code nix
       wants = [ 'NetworkManager-wait-online.service' ];
       after = [ 'NetworkManager-wait-online.service' ];
       @end
*** Timers
   {https://nixos.wiki/wiki/Systemd/Timers}[Source].
   {https://search.nixos.org/options?channel=23.11&from=0&size=50&sort=relevance&type=packages&query=systemd.timers.%3Cname%3E}[Options].
    Important options:
    - `serviceConfig.OnCalendar` - when. Kinda like chrone's format but different.
**** Example
     @code nix
     systemd.timers."hello-world" = {
       wantedBy = [ "timers.target" ];
         timerConfig = {
           OnBootSec = "5m";
           OnUnitActiveSec = "5m";
           Unit = "hello-world.service";
         };
     };

     systemd.services."hello-world" = {
       script = ''
         set -eu
         ${pkgs.coreutils}/bin/echo "Hello World"
       '';
       serviceConfig = {
         Type = "oneshot";
         User = "root";
       };
     };
     @end
**** Commands
     - `systemctl list-timers` - list active timers and their current state,
     - `systemctl start hello-world` - manually run a service once for testing purposes.
** Examples
   - {./dotfiles-updater.html}[dotfiles-updater].

* Tricks
** Updating inputs
   `nix flake lock --update-input <input> --commit-lock-file` updates single input.
   > (=) was replaced with `nix flake update --update-input` in 2.19

** Transfering evaluation results for system bootstrap
   When bootstrapping a new NixOS installation it's sometimes usefull to
   evaluate your config separately first:
   @code sh
   mkdir /tmp/store
   nix copy --to /tmp/store/ \
   "$(nix path-info --derivation someflake#nixosConfigurations.hostname.config.system.build.toplevel)"
   cd /tmp/store/
   tar cz . | ssh host 'mkdir -p /tmp/store; cd /tmp/store; tar xzf -'
   # on target
   cd /tmp/store
   drv="/$(find nix/store -maxdepth 1 -name "*nixos-system-hostname*" -type f)"
   cd -
   nix copy --from /tmp/store "$drv"
   nix-store --realise "$drv"
   @end

* Rerences
  - {./btrfs-on-nixos.html}[btrfs-on-nixos]
  - {./flake-parts.html}[flake-parts]
  - {./nix/merging-patches.html}[nix/merging-patches]
  - {./nixops.html}[nixops]
  - {./refresher.html}[refresher]
  - {./stylix.html}[stylix]
